function k(a) {
  return new Promise((function(f, d) {
    a.onerror = function() {
      d(a.error);
    };
    a.onsuccess = function() {
      f(a.result);
    };
  }));
}

function p(a) {
  return new Promise((function(f, d) {
    a.onerror = function() {
      d(a.error);
    };
    a.oncomplete = f;
  }));
}

function q() {
  return null;
}

function r() {}

function t() {}

function u(a) {
  window.addEventListener("online", (function() {
    a();
  }));
}

import { _ as _extends } from "./5301ccd2.mjs";

export function makeDefaultStorage(a) {
  function f(b) {
    for (var e, a = {}, c = "", f = "", m = 0, d = 0; d < b.length; ) {
      for (e = ""; ":" !== (c = b[d++]) && c; ) {
        e += c;
      }
      m ? (a[f] = e.replace(/%3a/g, ":") || void 0, m = 0) : (f = e.replace(/%3a/g, ":"), 
      m = 1);
    }
    return a;
  }
  function v(b) {
    (b = b.transaction("metadata", "readwrite")).objectStore("metadata").clear();
    b.objectStore("entries").clear();
    return p(b);
  }
  function w(b) {
    return k(b.transaction("metadata", "readonly").objectStore("metadata").get("metadata"));
  }
  function x(b) {
    return k(b.transaction("entries", "readwrite").objectStore("entries").put(function d() {
      var a, c, b = "";
      for (a in h) {
        c = h[a];
        b += a.replace(/:/g, "%3a");
        b += ":";
        c && (b += c.replace(/:/g, "%3a"));
        b += ":";
      }
      return b;
    }(), n));
  }
  function y() {
    return h;
  }
  a || (a = {});
  var z = a.idbName || "graphcache-v4", h = Object.create(null), n = Math.floor((new Date).valueOf() / 864e5), A = n - (a.maxAge || 7), l = indexedDB.open(z, 1), g = k(l);
  l.onupgradeneeded = function() {
    l.result.createObjectStore("entries");
    l.result.createObjectStore("metadata");
  };
  return {
    clear: function() {
      return g.then(v);
    },
    readMetadata: function() {
      return g.then(w, q);
    },
    writeMetadata: function(b) {
      g.then((function(a) {
        return k(a.transaction("metadata", "readwrite").objectStore("metadata").put(b, "metadata"));
      }), r);
    },
    writeData: function(b) {
      _extends(h, b);
      return g.then(x).then(t, t);
    },
    readData: function() {
      var b = [];
      return g.then((function(a) {
        var c = (a = a.transaction("entries", "readwrite")).objectStore("entries");
        (c.openKeyCursor || c.openCursor).call(c).onsuccess = function() {
          var e, d, g;
          if (this.result) {
            if ("number" != typeof (e = this.result.key) || e < A) {
              c.delete(e);
            } else {
              d = c.get(e), g = b.length;
              b.push("");
              d.onsuccess = function a() {
                var a = "" + d.result;
                e === n && _extends(h, f(a));
                b[g] = a;
              };
            }
            this.result.continue();
          }
        };
        return p(a);
      })).then((function() {
        return f(b.join(""));
      }), y);
    },
    onOnline: u
  };
}
//# sourceMappingURL=urql-exchange-graphcache-default-storage.mjs.map
